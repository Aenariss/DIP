<!DOCTYPE html>
<html>
<head>
    <title>Content Blocking Test</title>
    <script>
        let resources = {{ resources|tojson }};
        let total_resources = {{ n_of_resources }};
        total_resources = parseInt(total_resources);
        let loaded = 0;
        let blocked = 0;

        async function testResourceLoading() {
            for (let url of resources) {
                var success;
                try {
                    let response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                    if (response.ok || response.type === 'opaque') {
                        loaded++;
                        success = true;
                        total_resources--;
                    } else {
                        blocked++;
                        success = false;
                        total_resources--;
                    }
                } catch (error) {
                    blocked++;
                    success = false;
                    total_resources--;
                }
                updateResults(success, url);
            }
        }

        function updateResults(response, url) {
            document.getElementById('loaded-count').innerText = loaded;
            document.getElementById('blocked-count').innerText = blocked;
            document.getElementById('waiting-count').innerText = total_resources;
            
            let status = response ?  "Loaded" : "Not loaded";

            let status_update =  url + "... " + status + '<br>'
            document.getElementById('current_resource').innerHTML += status_update;
        }

        function overrideFetch() {
            /*
                Function to override original fetch to check how many resources have
                been fetched or are pending to be fetched
            */
            window.total_fetch_count = { pending: 0, completed: 0 };

            // save the original fetch function
            const originalFetch = window.fetch;
            window.fetch = function(...args) {

                // once fetch was called, add it to pending
                window.total_fetch_count.pending++;

                // apply the original fetcj
                return originalFetch.apply(this, args).then(response => {
                    // after resolving fetch, remove from pending and add to completed
                    window.total_fetch_count.pending--;
                    window.total_fetch_count.completed++;
                    return response;
                }).catch(error => {
                    // in case of an error, its resolved either way - remove from pending, add compelted
                    window.total_fetch_count.pending--;
                    window.total_fetch_count.completed++;
                    throw error;
                });
            };
        }

        overrideFetch();
        
        // start fetching on page load
        window.addEventListener('load', testResourceLoading);

    </script>
</head>
<body>
    <h1>Content Blocking Test</h1>
    <p>Fetches waiting for:<span id="waiting-count">0</span></p>
    <p>Loaded resources: <span id="loaded-count">0</span></p>
    <p>Blocked resources: <span id="blocked-count">0</span></p>

    <p>Resource status: <p id="current_resource"></p></p>
</body>
</html>